@page "/lookup"
@using System.Net.Http.Json
@using System.Linq
@using System.Text
@using SonosControl.DAL.Interfaces
@inject IUnitOfWork _uow
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IHttpClientFactory HttpClientFactory
@using SonosControl.Web.Data
@inject ApplicationDbContext Db
@using SonosControl.Web.Models
@implements IDisposable
@attribute [Authorize(Roles = "admin,operator,superadmin")]


<div class="lookup-shell surface-1 rounded-4 shadow-sm border border-secondary">
    <header class="lookup-shell__header">
        <div>
            <h2 class="lookup-shell__title">üìª Station Lookup</h2>
            <p class="text-muted mb-0">Search and persist radio stations for the Sonos system.</p>
        </div>
        <p class="text-muted small mb-0">Live data powered by Radio Browser.</p>
    </header>

    @if (!string.IsNullOrEmpty(saveSuccessMessage))
    {
        <div class="alert alert-success mb-0">@saveSuccessMessage</div>
    }

    @if (!string.IsNullOrEmpty(addStationErrorMessage))
    {
        <div class="alert alert-danger mb-0">@addStationErrorMessage</div>
    }

    @if (!string.IsNullOrEmpty(searchErrorMessage))
    {
        <div class="alert alert-warning mb-0">@searchErrorMessage</div>
    }

    <div class="lookup-shell__search">
        <label for="stationSearch" class="visually-hidden">Search for a radio station</label>
        <div class="lookup-search-wrapper">
            <input id="stationSearch"
                   @ref="searchInput"
                   class="lookup-shell__search-input form-control"
                   @bind-value="searchTerm"
                   @bind-value:event="oninput"
                   placeholder="Search for a radio station..."
                   @onkeydown="HandleKeyDown"/>
            @if (!string.IsNullOrEmpty(searchTerm))
            {
                <button type="button" class="lookup-clear-button" @onclick="ClearSearch" aria-label="Clear search" title="Clear search">
                    ‚úñ
                </button>
            }
        </div>
        <button class="lookup-shell__search-button btn btn-primary"
                @onclick="SearchStations"
                disabled="@(string.IsNullOrWhiteSpace(searchTerm) || isLoading)"
                aria-label="Search stations"
                title="Search stations">
            @if (isLoading)
            {
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                <span class="visually-hidden">Searching...</span>
            }
            else
            {
                <span>üîç</span>
            }
        </button>
    </div>

    @if (results?.Any() == true)
    {
        <ul class="list-group list-group-flush lookup-results">
            @foreach (var station in results)
            {
                <li class="list-group-item lookup-result">
                    <div class="lookup-info">
                        <div class="d-flex align-items-center gap-2">
                            <span class="display-6">@GetFlagEmoji(station.CountryCode)</span>
                            <div class="flex-grow-1">
                                <strong>@station.Name</strong>
                                <small class="text-muted d-block">@GetCleanUrl(station.Url)</small>
                            </div>
                        </div>
                        @if (!string.IsNullOrWhiteSpace(station.Tags))
                        {
                            <div class="d-flex gap-1 flex-wrap mt-2">
                                @foreach(var tag in station.Tags.Split(',').Take(3))
                                {
                                    <span class="badge bg-secondary bg-opacity-25 text-dark-emphasis">@tag</span>
                                }
                            </div>
                        }
                    </div>
                    <div class="lookup-actions">
                        <button type="button"
                                class="lookup-action-button btn btn-outline-success"
                                @onclick="() => PlayStation(station.Url)"
                                aria-label="@($"Play {station.Name}")"
                                title="@($"Play {station.Name}")"
                                disabled="@IsLoading($"play-{station.Url}")">
                            @if (IsLoading($"play-{station.Url}"))
                            {
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                            }
                            else
                            {
                                <span>üîä</span>
                            }
                        </button>
                        @if (IsStationSaved(station))
                        {
                            <button type="button" class="lookup-action-button btn btn-outline-primary" disabled>
                                ‚úÖ
                            </button>
                        }
                        else
                        {
                            <button type="button"
                                    class="lookup-action-button btn btn-outline-primary"
                                    @onclick="() => SaveStation(station)"
                                    aria-label="@($"Save {station.Name}")"
                                    title="@($"Save {station.Name}")"
                                    disabled="@IsLoading($"save-{station.Url}")">
                                @if (IsLoading($"save-{station.Url}"))
                                {
                                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                }
                                else
                                {
                                    <span>üíæ</span>
                                }
                            </button>
                        }
                    </div>
                </li>
            }
        </ul>
    }
    else if (results is not null)
    {
        <p class="text-center text-muted mb-0">No stations found.</p>
    }
</div>

@code {
    private SonosSettings? _settings;
    private string? searchTerm;
    private ElementReference searchInput;
    private List<RadioStation>? results;
    private bool isLoading = false;
    private HashSet<string> _loadingStates = new();
    private string? saveSuccessMessage;
    private string? searchErrorMessage;
    private bool isAuthenticated;
    private CancellationTokenSource? _searchCts;
    private CancellationTokenSource? _saveMessageCts;
    private bool _isDisposing;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        isAuthenticated = user.Identity?.IsAuthenticated ?? false;

        if (isAuthenticated)
        {
            _settings = await _uow.SettingsRepo.GetSettings();
        }
    }

    private async Task SearchStations()
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            return;
        }

        var requestCts = new CancellationTokenSource(TimeSpan.FromSeconds(10));
        var previousCts = _searchCts;
        _searchCts = requestCts;
        previousCts?.Cancel();
        previousCts?.Dispose();

        isLoading = true;
        results = null;
        searchErrorMessage = null;
        StateHasChanged();

        try
        {
            var token = requestCts.Token;
            var http = HttpClientFactory.CreateClient("RadioBrowser");
            var query = Uri.EscapeDataString(searchTerm.Trim());
            var apiUrl = $"json/stations/search?name={query}";
            var searchResults = await http.GetFromJsonAsync<List<RadioStation>>(apiUrl, token);

            if (searchResults is not null)
            {
                results = searchResults
                    .Where(station => station is not null && !string.IsNullOrWhiteSpace(station.Url) && !string.IsNullOrWhiteSpace(station.Name))
                    .GroupBy(station => new { Name = station.Name.Trim(), Url = NormalizeUrl(station.Url) })
                    .Select(group => group.First())
                    .Take(50)
                    .ToList();
            }
            else
            {
                results = new List<RadioStation>();
            }
        }
        catch (OperationCanceledException) when (!_isDisposing && ReferenceEquals(_searchCts, requestCts))
        {
            searchErrorMessage = "Station lookup timed out. Try a narrower search.";
            results = new List<RadioStation>();
        }
        catch (HttpRequestException ex) when (ReferenceEquals(_searchCts, requestCts))
        {
            searchErrorMessage = $"Station lookup failed: {ex.Message}";
            results = new List<RadioStation>();
        }
        catch (Exception ex) when (ReferenceEquals(_searchCts, requestCts))
        {
            searchErrorMessage = $"Error fetching stations: {ex.Message}";
            results = new List<RadioStation>();
        }
        finally
        {
            if (ReferenceEquals(_searchCts, requestCts))
            {
                isLoading = false;
                StateHasChanged();
            }
        }
    }
    
    private bool IsLoading(string key) => _loadingStates.Contains(key);

    private bool IsStationSaved(RadioStation station)
    {
        if (_settings?.Stations == null) return false;
        
        string normalizedUrl = NormalizeUrl(station.Url);
        string normalizedName = station.Name.Trim().ToLowerInvariant();
        
        return _settings.Stations.Any(s =>
            NormalizeUrl(s.Url) == normalizedUrl ||
            s.Name.Trim().ToLowerInvariant() == normalizedName);
    }
    
    private string GetFlagEmoji(string countryCode)
    {
        if (string.IsNullOrWhiteSpace(countryCode) || countryCode.Length != 2)
            return "üè≥Ô∏è";
        
        return string.Concat(countryCode.ToUpperInvariant().Select(c => char.ConvertFromUtf32(c + 0x1F1E6 - 'A')));
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        // Check if the pressed key is the "Enter" key
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(searchTerm))
        {
            await SearchStations();
        }
    }

    private async Task ClearSearch()
    {
        searchTerm = string.Empty;
        results = null;
        searchErrorMessage = null;
        await searchInput.FocusAsync();
    }

    private string GetCleanUrl(string url)
    {
        string cleanUrl;
        try
        {
            var uri = new Uri(url);
            cleanUrl = uri.Host + uri.AbsolutePath;
        }
        catch
        {
            cleanUrl = url;
        }

        if (cleanUrl.Length > 30)
        {
            return cleanUrl.Substring(0, 30) + "...";
        }
        return cleanUrl;
    }

    private async Task PlayStation(string url)
    {
        if (_settings is not null)
        {
            var key = $"play-{url}";
            _loadingStates.Add(key);
            StateHasChanged();

            try
            {
                await _uow.SonosConnectorRepo.SetTuneInStationAsync(_settings.IP_Adress, url);
                Console.WriteLine($@"Station {url} played successfully.");
                await AddLog("Playing Station", $"station: {url}");
            }
            finally
            {
                _loadingStates.Remove(key);
                StateHasChanged();
            }
        }
    }

    public class RadioStation
    {
        public string Name { get; set; } = "";
        public string Url { get; set; } = "";
        public string Country { get; set; } = "";
        public string CountryCode { get; set; } = "";
        public string Tags { get; set; } = "";
    }

    private string? addStationErrorMessage;

    private async Task SaveStation(RadioStation station)
    {
        addStationErrorMessage = null;
        saveSuccessMessage = null;

        if (_settings == null)
        {
            addStationErrorMessage = "Settings not loaded.";
            return;
        }

        var key = $"save-{station.Url}";
        _loadingStates.Add(key);
        StateHasChanged();

        try
        {
            _settings.Stations ??= new List<TuneInStation>();

            if (IsStationSaved(station))
            {
                addStationErrorMessage = "Station is already saved.";
                return;
            }

            _settings.Stations.Add(new TuneInStation { Name = station.Name, Url = station.Url });
            await SaveSettings();
            await AddLog("Added Station", $"station: {station.Name}, ({station.Url})");

            saveSuccessMessage = $"‚úÖ \"{station.Name}\" saved!";
            ScheduleSaveMessageClear();
        }
        catch (Exception ex)
        {
            addStationErrorMessage = $"Error saving station: {ex.Message}";
        }
        finally
        {
            _loadingStates.Remove(key);
            StateHasChanged();
        }
    }

    private string NormalizeUrl(string url)
    {
        try
        {
            var uri = new Uri(url);
            return uri.Host.ToLowerInvariant().TrimEnd('/') + uri.AbsolutePath.ToLowerInvariant().TrimEnd('/');
        }
        catch
        {
            return url?.Trim().ToLowerInvariant() ?? "";
        }
    }

    private async Task SaveSettings()
    {
        if (_settings is null) return;
        await _uow.SettingsRepo.WriteSettings(_settings);
    }

    private async Task AddLog(string action, string? details = null)
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var username = user.Identity?.Name ?? "Unknown";

        var log = new LogEntry
        {
            Action = action,
            PerformedBy = username,
            Timestamp = DateTime.UtcNow,
            Details = details
        };

        Db.Logs.Add(log);
        await Db.SaveChangesAsync();
    }

    private void ScheduleSaveMessageClear()
    {
        _saveMessageCts?.Cancel();
        _saveMessageCts?.Dispose();
        _saveMessageCts = new CancellationTokenSource();
        _ = ClearSaveMessageAfterDelayAsync(_saveMessageCts.Token);
    }

    private async Task ClearSaveMessageAfterDelayAsync(CancellationToken token)
    {
        try
        {
            await Task.Delay(3000, token);
            saveSuccessMessage = null;
            await InvokeAsync(StateHasChanged);
        }
        catch (OperationCanceledException) when (token.IsCancellationRequested)
        {
        }
    }

    public void Dispose()
    {
        _isDisposing = true;
        _searchCts?.Cancel();
        _searchCts?.Dispose();
        _saveMessageCts?.Cancel();
        _saveMessageCts?.Dispose();
    }
}


