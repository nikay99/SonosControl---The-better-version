@page "/admin/users"
@using Microsoft.AspNetCore.Identity
@using SonosControl.Web.Models
@inject UserManager<ApplicationUser> UserManager
@inject RoleManager<IdentityRole> RoleManager
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@using SonosControl.Web.Data
@inject ApplicationDbContext Db
@inject IJSRuntime JS
@inject IUnitOfWork _uow
@attribute [Authorize(Roles = "admin,operator,superadmin")]

<PageTitle>User Management</PageTitle>

<div class="user-management-shell">
    <section class="panel user-management-panel stack-lg" aria-labelledby="user-management-heading">
        <header class="user-management__header">
            <div>
                <h3 id="user-management-heading" class="page-title mb-1">ðŸ‘¥ User Management</h3>
                <p class="text-muted small mb-0">Manage accounts, roles, and activation states securely.</p>
            </div>
            @if (isAdmin)
            {
                <div class="user-management__header-control">
                    <FormField Label="Allow user registration"
                               Id="@RegistrationSwitchId"
                               HelperText="@RegistrationSwitchHelperText">
                        <div class="form-check form-switch m-0">
                            <input class="form-check-input user-management__switch"
                                   type="checkbox"
                                   role="switch"
                                   id="@RegistrationSwitchId"
                                   checked="@allowUserRegistration"
                                   @onchange="ToggleRegistration"
                                   aria-label="Allow user registration toggle" />
                        </div>
                    </FormField>
                </div>
            }
        </header>

        <div class="user-management__body stack-md">
            @if (isLoading)
            {
                <p class="text-muted mb-0">Loading users...</p>
            }
            else
            {
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <FormStatus StatusMessage="@errorMessage" Severity="FormStatus.AlertSeverity.Danger" />
                }

                <!-- Desktop Table View -->
                <div class="d-none d-md-block table-responsive user-management__table-wrapper">
                    <table class="table user-management-table mb-0">
                        <thead>
                        <tr>
                            <th scope="col">User</th>
                            <th scope="col" class="d-none d-xl-table-cell">First</th>
                            <th scope="col" class="d-none d-xl-table-cell">Last</th>
                            <th scope="col" class="d-none d-md-table-cell">Email</th>
                            <th scope="col" class="d-none d-lg-table-cell">Roles</th>
                            <th scope="col" class="text-center">Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        @foreach (var user in users)
                        {
                            <tr>
                                <td>@user.UserName</td>

                                <td class="d-none d-xl-table-cell">@user.FirstName</td>
                                <td class="d-none d-xl-table-cell">@user.LastName</td>

                                <td class="d-none d-md-table-cell">@user.Email</td>

                                <td class="d-none d-lg-table-cell user-management__roles">
                                    @foreach (var role in userRoles[user.Id])
                                    {
                                        <span class="badge user-role-badge">@role</span>
                                    }
                                </td>

                                <td class="text-center">
                                    <div class="user-actions">
                                        <button type="button"
                                                class="btn btn-outline-danger user-action-btn"
                                                @onclick="() => DeleteUser(user)"
                                                disabled="@(IsCurrentUser(user) || (!isSuperAdmin && userRoles[user.Id].Contains("superadmin")) || IsLoading($"delete-{user.Id}"))"
                                                aria-label="@($"Delete user {user.UserName}")">
                                            @if (IsLoading($"delete-{user.Id}"))
                                            {
                                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                            }
                                            else
                                            {
                                                <span>Delete</span>
                                            }
                                        </button>

                                        @if (isSuperAdmin)
                                        {
                                            <button type="button"
                                                    class="btn btn-outline-primary user-action-btn"
                                                    @onclick='() => ToggleRole(user, "admin")'
                                                    disabled="@(IsCurrentUser(user) || IsLoading($"role-{user.Id}-admin"))"
                                                    aria-label="@($"{(userRoles[user.Id].Contains("admin") ? "Remove" : "Add")} Admin role for {user.UserName}")">
                                                @if (IsLoading($"role-{user.Id}-admin"))
                                                {
                                                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                                }
                                                else
                                                {
                                                    @(userRoles[user.Id].Contains("admin") ? "âˆ’Admin" : "+Admin")
                                                }
                                            </button>

                                            <button type="button"
                                                    class="btn btn-outline-secondary user-action-btn"
                                                    @onclick='() => ToggleRole(user, "operator")'
                                                    disabled="@(IsCurrentUser(user) || IsLoading($"role-{user.Id}-operator"))"
                                                    aria-label="@($"{(userRoles[user.Id].Contains("operator") ? "Remove" : "Add")} Operator role for {user.UserName}")">
                                                @if (IsLoading($"role-{user.Id}-operator"))
                                                {
                                                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                                }
                                                else
                                                {
                                                    @(userRoles[user.Id].Contains("operator") ? "âˆ’Operator" : "+Operator")
                                                }
                                            </button>

                                            <button type="button"
                                                    class="btn btn-outline-warning user-action-btn"
                                                    @onclick='() => ToggleRole(user, "superadmin")'
                                                    disabled="@(IsCurrentUser(user) || IsLoading($"role-{user.Id}-superadmin"))"
                                                    aria-label="@($"{(userRoles[user.Id].Contains("superadmin") ? "Remove" : "Add")} Superuser role for {user.UserName}")">
                                                @if (IsLoading($"role-{user.Id}-superadmin"))
                                                {
                                                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                                }
                                                else
                                                {
                                                    @(userRoles[user.Id].Contains("superadmin") ? "âˆ’Superuser" : "+Superuser")
                                                }
                                            </button>
                                        }

                                        <button type="button"
                                                class="btn user-action-btn @GetActivationButtonClass(user)"
                                                @onclick='() => ToggleUserActivation(user)'
                                                disabled="@(IsCurrentUser(user) || IsLoading($"activation-{user.Id}"))"
                                                aria-label="@($"{(IsUserActive(user) ? "Deactivate" : "Activate")} user {user.UserName}")">
                                            @if (IsLoading($"activation-{user.Id}"))
                                            {
                                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                            }
                                            else
                                            {
                                                @(IsUserActive(user) ? "âœ”" : "â›”")
                                            }
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>

                <!-- Mobile Card View -->
                <div class="d-md-none stack-md">
                    @foreach (var user in users)
                    {
                        <div class="card shadow-sm border-0">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="rounded-circle bg-light d-flex align-items-center justify-content-center border" style="width: 40px; height: 40px;">
                                            <span class="oi oi-person text-secondary"></span>
                                        </div>
                                        <div style="min-width: 0;">
                                            <h6 class="mb-0 fw-bold text-truncate">@user.UserName</h6>
                                            <div class="small text-muted text-truncate">@user.Email</div>
                                        </div>
                                    </div>
                                    <span class="badge rounded-pill @(IsUserActive(user) ? "bg-success" : "bg-danger")">
                                        @(IsUserActive(user) ? "Active" : "Inactive")
                                    </span>
                                </div>

                                <div class="mb-3">
                                    <span class="text-uppercase text-muted small fw-bold d-block mb-1" style="font-size: 0.7rem;">Roles</span>
                                    @if (userRoles[user.Id].Any())
                                    {
                                        <div class="d-flex flex-wrap gap-1">
                                            @foreach (var role in userRoles[user.Id])
                                            {
                                                <span class="badge bg-light text-dark border">@role</span>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="text-muted small fst-italic">No roles assigned</span>
                                    }
                                </div>

                                @if (!IsCurrentUser(user))
                                {
                                    <hr class="my-3 text-muted opacity-25" />
                                    <div class="d-grid gap-2">
                                        @if (isSuperAdmin)
                                        {
                                            <div class="row g-2">
                                                <div class="col-6">
                                                    <button class="btn btn-sm w-100 @(userRoles[user.Id].Contains("admin") ? "btn-outline-danger" : "btn-outline-primary")"
                                                            @onclick='() => ToggleRole(user, "admin")'
                                                            disabled="@IsLoading($"role-{user.Id}-admin")"
                                                            aria-label="@($"{(userRoles[user.Id].Contains("admin") ? "Remove" : "Add")} Admin role for {user.UserName}")">
                                                        @if (IsLoading($"role-{user.Id}-admin"))
                                                        {
                                                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                                        }
                                                        else
                                                        {
                                                            <span class="oi @(userRoles[user.Id].Contains("admin") ? "oi-minus" : "oi-plus")" aria-hidden="true"></span> <span>Admin</span>
                                                        }
                                                    </button>
                                                </div>
                                                <div class="col-6">
                                                    <button class="btn btn-sm w-100 @(userRoles[user.Id].Contains("operator") ? "btn-outline-danger" : "btn-outline-secondary")"
                                                            @onclick='() => ToggleRole(user, "operator")'
                                                            disabled="@IsLoading($"role-{user.Id}-operator")"
                                                            aria-label="@($"{(userRoles[user.Id].Contains("operator") ? "Remove" : "Add")} Operator role for {user.UserName}")">
                                                        @if (IsLoading($"role-{user.Id}-operator"))
                                                        {
                                                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                                        }
                                                        else
                                                        {
                                                            <span class="oi @(userRoles[user.Id].Contains("operator") ? "oi-minus" : "oi-plus")" aria-hidden="true"></span> <span>Operator</span>
                                                        }
                                                    </button>
                                                </div>
                                            </div>
                                        }

                                        <div class="row g-2">
                                            <div class="col-6">
                                                <button class="btn btn-sm btn-outline-danger w-100"
                                                        @onclick="() => DeleteUser(user)"
                                                        disabled="@((!isSuperAdmin && userRoles[user.Id].Contains("superadmin")) || IsLoading($"delete-{user.Id}"))"
                                                        aria-label="@($"Delete user {user.UserName}")">
                                                    @if (IsLoading($"delete-{user.Id}"))
                                                    {
                                                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                                    }
                                                    else
                                                    {
                                                        <span class="oi oi-trash" aria-hidden="true"></span> <span>Delete</span>
                                                    }
                                                </button>
                                            </div>
                                            <div class="col-6">
                                                <button class="btn btn-sm w-100 @(IsUserActive(user) ? "btn-outline-warning" : "btn-outline-success")"
                                                        @onclick='() => ToggleUserActivation(user)'
                                                        disabled="@IsLoading($"activation-{user.Id}")"
                                                        aria-label="@($"{(IsUserActive(user) ? "Deactivate" : "Activate")} user {user.UserName}")">
                                                    @if (IsLoading($"activation-{user.Id}"))
                                                    {
                                                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                                    }
                                                    else
                                                    {
                                                        <span class="oi @(IsUserActive(user) ? "oi-ban" : "oi-check")" aria-hidden="true"></span> @(IsUserActive(user) ? "Block" : "Activate")
                                                    }
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>

                <div class="user-management__legend d-none d-md-block">
                    <strong>Legend:</strong>
                    <span class="ms-3">âœ” = Active</span>
                    <span class="ms-3">â›” = Deactivated</span>
                </div>
            }
        </div>
    </section>
</div>

@code {
    private List<ApplicationUser> users = new();
    private Dictionary<string, IList<string>> userRoles = new();
    private bool isLoading = true;
    private string? errorMessage;
    private string? currentUserName;
    private bool isSuperAdmin;
    private bool isAdmin;
    private bool allowUserRegistration;
    private SonosSettings? _settings;
    private readonly string RegistrationSwitchId = $"allowRegistrationSwitch_{System.Guid.NewGuid():N}";

    private HashSet<string> _loadingStates = new();
    private bool IsLoading(string key) => _loadingStates.Contains(key);

    private string RegistrationSwitchHelperText => allowUserRegistration ? "Open to new users." : "Closed to new signups.";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        currentUserName = authState.User.Identity?.Name;
        isSuperAdmin = authState.User.IsInRole("superadmin");
        isAdmin = isSuperAdmin || authState.User.IsInRole("admin");

        try
        {
            users = UserManager.Users
                .OrderBy(u => u.UserName)
                .ToList();

            foreach (var user in users)
            {
                var roles = await UserManager.GetRolesAsync(user);
                userRoles[user.Id] = roles;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading users: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }

        _settings = await _uow.SettingsRepo.GetSettings();
        allowUserRegistration = _settings?.AllowUserRegistration ?? true;
    }

    private async Task ToggleRegistration(ChangeEventArgs e)
    {
        allowUserRegistration = e.Value is bool b && b;
        if (_settings is not null)
        {
            _settings.AllowUserRegistration = allowUserRegistration;
            await _uow.SettingsRepo.WriteSettings(_settings);
            await AddLog(allowUserRegistration ? "Registration enabled" : "Registration disabled");
        }
    }

    private async Task DeleteUser(ApplicationUser user)
    {
        if (IsCurrentUser(user))
        {
            errorMessage = "You cannot delete your own user account.";
            return;
        }

        if (userRoles[user.Id].Contains("superadmin") && !isSuperAdmin)
        {
            errorMessage = "You cannot delete a super administrator.";
            return;
        }

        var confirmed = await JS.InvokeAsync<bool>("confirm", $"Are you sure you want to delete user '{user.UserName}'?");
        if (!confirmed) return;

        var key = $"delete-{user.Id}";
        if (_loadingStates.Contains(key)) return;
        _loadingStates.Add(key);
        StateHasChanged();

        try
        {
            var result = await UserManager.DeleteAsync(user);
            if (result.Succeeded)
            {
                users.Remove(user);
                userRoles.Remove(user.Id);
                errorMessage = null;
                await AddLog("User deleted", $"user: {user.UserName}, {user.FirstName}, {user.LastName}, {user.Email}");
            }
            else
            {
                errorMessage = $"Failed to delete user: {string.Join(", ", result.Errors.Select(e => e.Description))}";
            }
        }
        finally
        {
            _loadingStates.Remove(key);
            StateHasChanged();
        }
    }

    private bool IsUserActive(ApplicationUser user)
    {
        // If LockoutEnabled is false, user is active.
        // Or if LockoutEnd is in the past or null, user is active.
        if (!user.LockoutEnabled)
            return true;

        if (user.LockoutEnd == null)
            return true;

        return user.LockoutEnd <= DateTimeOffset.UtcNow;
    }

    private async Task ToggleUserActivation(ApplicationUser user)
    {
        if (IsCurrentUser(user))
        {
            errorMessage = "You cannot deactivate/reactivate your own user account.";
            return;
        }

        var key = $"activation-{user.Id}";
        if (_loadingStates.Contains(key)) return;
        _loadingStates.Add(key);
        StateHasChanged();

        try
        {
            if (IsUserActive(user))
            {
                // Deactivate user: enable lockout and set LockoutEnd far in the future
                user.LockoutEnabled = true;
                user.LockoutEnd = DateTimeOffset.MaxValue;
                await AddLog("User deactivated", $"user: {user.UserName}, {user.FirstName}, {user.LastName}, {user.Email}");
            }
            else
            {
                // Reactivate user: disable lockout and clear LockoutEnd
                user.LockoutEnd = null;
                user.LockoutEnabled = false;
                await AddLog("User activated", $"user: {user.UserName}, {user.FirstName}, {user.LastName}, {user.Email}");
            }

            var result = await UserManager.UpdateAsync(user);

            if (result.Succeeded)
            {
                errorMessage = null;
                // Update the local user list to reflect changes
                var index = users.FindIndex(u => u.Id == user.Id);
                if (index >= 0)
                    users[index] = user;
            }
            else
            {
                errorMessage = $"Failed to update user activation status: {string.Join(", ", result.Errors.Select(e => e.Description))}";
            }
        }
        finally
        {
            _loadingStates.Remove(key);
            StateHasChanged();
        }
    }

    private string GetActivationButtonClass(ApplicationUser user) =>
        IsUserActive(user) ? "btn-outline-success" : "btn-outline-warning";

    private async Task ToggleRole(ApplicationUser user, string role)
    {
        if (!isSuperAdmin)
        {
            errorMessage = "Only super administrators can modify roles.";
            return;
        }

        if (IsCurrentUser(user))
        {
            errorMessage = "You cannot modify your own roles.";
            return;
        }

        if (!await RoleManager.RoleExistsAsync(role))
        {
            errorMessage = $"Role '{role}' does not exist.";
            return;
        }

        var key = $"role-{user.Id}-{role}";
        if (_loadingStates.Contains(key)) return;
        _loadingStates.Add(key);
        StateHasChanged();

        try
        {
            if (userRoles[user.Id].Contains(role))
            {
                var removeResult = await UserManager.RemoveFromRoleAsync(user, role);
                if (removeResult.Succeeded)
                {
                    userRoles[user.Id] = await UserManager.GetRolesAsync(user);
                    errorMessage = null;
                }
                else
                {
                    errorMessage = $"Failed to remove role '{role}': {string.Join(", ", removeResult.Errors.Select(e => e.Description))}";
                }
            }
            else
            {
                var addResult = await UserManager.AddToRoleAsync(user, role);
                if (addResult.Succeeded)
                {
                    userRoles[user.Id] = await UserManager.GetRolesAsync(user);
                    errorMessage = null;
                }
                else
                {
                    errorMessage = $"Failed to add role '{role}': {string.Join(", ", addResult.Errors.Select(e => e.Description))}";
                }
            }
        }
        finally
        {
            _loadingStates.Remove(key);
            StateHasChanged();
        }
    }

    private bool IsCurrentUser(ApplicationUser user)
    {
        return string.Equals(user.UserName, currentUserName, StringComparison.OrdinalIgnoreCase);
    }

    private async Task AddLog(string action, string? details = null)
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var username = user.Identity?.Name ?? "Unknown";

        var log = new LogEntry
        {
            Action = action,
            PerformedBy = username,
            Timestamp = DateTime.UtcNow,
            Details = details
        };

        Db.Logs.Add(log);
        await Db.SaveChangesAsync();
    }

}


