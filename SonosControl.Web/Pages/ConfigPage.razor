@page "/config"
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JS
@using SonosControl.Web.Data
@inject ApplicationDbContext Db
@using SonosControl.Web.Models
@using SonosControl.Web.Services
@using System.Linq
@using System.Globalization
@using System;
@using System.Net
@attribute [Authorize(Roles = "admin,superadmin")]

@if (_settings is null)
{
    <p class="text-muted">Loading settings...</p>
}
else
{
    <div class="config-shell surface-1 rounded-4 shadow-sm border border-secondary">
        <header class="config-shell__header">
            <div>
                <h2 class="config-shell__title">üîß System Configuration</h2>
                <p class="text-muted mb-0">Fine-tune playback behavior, schedules, and overrides for the Sonos speaker.</p>
            </div>
            <p class="text-muted small mb-0">Changes save automatically.</p>
        </header>

        <div class="config-tabs-scroll">
        <nav class="nav nav-tabs px-4 config-tabs">
            <button class="nav-link @(_activeTab == "device" ? "active" : "")" @onclick="@(() => _activeTab = "device")">üéõÔ∏è Device</button>
            <button class="nav-link @(_activeTab == "schedules" ? "active" : "")" @onclick="@(() => _activeTab = "schedules")">üìÖ Schedules</button>
            <button class="nav-link @(_activeTab == "holidays" ? "active" : "")" @onclick="@(() => _activeTab = "holidays")">üéØ Holidays</button>
        </nav>
        </div>

        <div class="tab-content p-4">
            @if (_activeTab == "device")
            {
                <div class="config-field-stack">
                    <div class="config-field">
                        <label class="form-label">üîà Speakers</label>
                        @if (_settings.Speakers.Any())
                        {
                            <div class="list-group mb-3">
                                @foreach (var speaker in _settings.Speakers)
                                {
                                    <div class="list-group-item d-flex justify-content-between align-items-center flex-wrap gap-3">
                                        <div class="flex-grow-1">
                                            <strong class="d-block text-truncate">@speaker.Name</strong>
                                            <div class="text-muted small">@speaker.IpAddress</div>
                                        </div>
                                        <div class="d-flex align-items-center gap-2">
                                            <div class="input-group input-group-sm speaker-volume-group">
                                                <span class="input-group-text">Vol</span>
                                                <input type="number" class="form-control"
                                                       min="0" max="100"
                                                       value="@speaker.StartupVolume"
                                                       @onchange="async (e) => await UpdateStartupVolume(speaker, e.Value)"
                                                       disabled="@(!canEditIp)"
                                                       placeholder="@_settings.Volume"
                                                       aria-label="@($"Startup Volume for {speaker.Name}")" />
                                            </div>
                                            <button class="btn btn-sm btn-outline-danger" @onclick="() => RemoveSpeaker(speaker)" disabled="@(!canEditIp)" aria-label="@($"Remove speaker {speaker.Name}")">Remove</button>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <p class="text-muted">No speakers configured.</p>
                        }

                        <div class="card p-3">
                            <h6>Add New Speaker</h6>
                            @if (!string.IsNullOrEmpty(_speakerValidationMessage))
                            {
                                <div class="alert alert-danger mb-2 p-2 small">@_speakerValidationMessage</div>
                            }
                            <div class="mb-2">
                                <label class="form-label" for="newSpeakerName">Name</label>
                                <input id="newSpeakerName" type="text" class="form-control" @bind="_newSpeakerName" placeholder="e.g. Living Room" disabled="@(!canEditIp)" />
                            </div>
                            <div class="mb-2">
                                <label class="form-label" for="newSpeakerIp">IP Address</label>
                                <input id="newSpeakerIp" type="text" class="form-control" @bind="_newSpeakerIp" placeholder="e.g. 192.168.1.50" disabled="@(!canEditIp)" />
                            </div>
                            <button class="btn btn-primary btn-sm" @onclick="AddSpeaker" disabled="@(!canEditIp || string.IsNullOrWhiteSpace(_newSpeakerIp) || _isAddingSpeaker)">
                                @if (_isAddingSpeaker)
                                {
                                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                    <span class="visually-hidden">Adding...</span>
                                }
                                else
                                {
                                    <span>Add Speaker</span>
                                }
                            </button>
                        </div>
                    </div>

                    <div class="config-field">
                        <label class="form-label" for="discordWebhook">üì¢ Discord Webhook</label>
                        @if (_editingDiscordWebhook)
                        {
                            <div class="input-group">
                                <input id="discordWebhook" type="url" class="form-control"
                                       @bind-value="_settings.DiscordWebhookUrl"
                                       @bind-value:event="oninput"
                                       @bind-value:after="SaveSettings"
                                       placeholder="https://discord.com/api/webhooks/..."
                                       aria-label="Discord Webhook URL"
                                       autofocus />
                                <button class="btn btn-outline-secondary" @onclick="() => _editingDiscordWebhook = false" aria-label="Save Discord Webhook">Done</button>
                            </div>
                        }
                        else
                        {
                            <div class="d-flex gap-2">
                                <div class="form-control text-muted text-truncate surface-2">
                                    @GetTruncatedUrl(_settings.DiscordWebhookUrl)
                                </div>
                                <button class="btn btn-outline-primary" @onclick="() => _editingDiscordWebhook = true" aria-label="Edit Discord Webhook">Edit</button>
                            </div>
                        }
                        <div class="form-text text-muted text-opacity-75">
                            Notifications will be sent here for playback events and errors.
                        </div>
                    </div>

                    <div class="config-field">
                        <label class="form-label" for="teamsWebhook">üí¨ Teams Webhook</label>
                        @if (_editingTeamsWebhook)
                        {
                            <div class="input-group">
                                <input id="teamsWebhook" type="url" class="form-control"
                                       @bind-value="_settings.TeamsWebhookUrl"
                                       @bind-value:event="oninput"
                                       @bind-value:after="SaveSettings"
                                       placeholder="https://outlook.office.com/webhook/..."
                                       aria-label="Teams Webhook URL"
                                       autofocus />
                                <button class="btn btn-outline-secondary" @onclick="() => _editingTeamsWebhook = false" aria-label="Save Teams Webhook">Done</button>
                            </div>
                        }
                        else
                        {
                            <div class="d-flex gap-2">
                                <div class="form-control text-muted text-truncate surface-2">
                                    @GetTruncatedUrl(_settings.TeamsWebhookUrl)
                                </div>
                                <button class="btn btn-outline-primary" @onclick="() => _editingTeamsWebhook = true" aria-label="Edit Teams Webhook">Edit</button>
                            </div>
                        }
                        <div class="form-text text-muted text-opacity-75">
                            Teams notifications will be sent here for playback events and errors.
                        </div>
                    </div>

                    <div class="config-field">
                        <label class="form-label" for="autoPlay">üéµ Auto Play</label>
                        <select id="autoPlay" class="form-select"
                                @bind="AutoPlaySelection" @bind:event="onchange">
                            <option value="">-- None --</option>
                            <option value="randomStation">Random Station</option>
                            <option value="randomSpotify">Random Spotify</option>
                            <option value="randomYouTube">Random YouTube Music</option>
                            <optgroup label="Stations">
                                @foreach (var station in _settings.Stations)
                                {
                                    <option value="station:@station.Url">@station.Name</option>
                                }
                            </optgroup>
                            <optgroup label="Spotify">
                                @foreach (var track in _settings.SpotifyTracks)
                                {
                                    <option value="spotify:@track.Url">@track.Name</option>
                                }
                            </optgroup>
                            <optgroup label="YouTube Music">
                                @foreach (var collection in _settings.YouTubeMusicCollections)
                                {
                                    <option value="youtube:@collection.Url">@collection.Name</option>
                                }
                            </optgroup>
                        </select>
                    </div>

                    <div class="config-field">
                        <label class="form-label" for="maxVolume">üîä Max Volume</label>
                        <input id="maxVolume" type="number" class="form-control"
                               min="0" max="100"
                               @bind-value="MaxVolume"
                               @bind-value:event="oninput"/>
                        <div class="form-text text-muted text-opacity-75">
                            Limits the highest volume that can be set from the main control panel.
                        </div>
                    </div>
                </div>
            }
            @if (_activeTab == "schedules")
            {
                <div class="schedule-grid">
                    <div class="schedule-field">
                        <label class="form-label" for="startTime">‚è∞ Start Time</label>
                        <input id="startTime" type="time" class="form-control"
                               @bind-value="StartTime"
                               @bind-value:event="oninput"/>
                    </div>
                    <div class="schedule-field">
                        <label class="form-label" for="stopTime">üõë Stop Time</label>
                        <input id="stopTime" type="time" class="form-control"
                               @bind-value="StopTime"
                               @bind-value:event="oninput"/>
                    </div>
                    <div class="schedule-field">
                        <label class="form-label" for="serverTime">üìÖ Server Time</label>
                        <input id="serverTime" type="time" class="form-control"
                               disabled
                               @bind-value="TimeRightNow"/>
                    </div>
                </div>

                <div class="schedule-days">
                    <label class="form-label d-block">üìÜ Active Days</label>
                    <div class="active-days-grid">
                        @foreach (var day in Enum.GetValues<DayOfWeek>().OrderBy(d => ((int) d + 6) % 7))
                        {
                            <div>
                                <input type="checkbox"
                                       class="btn-check"
                                       id="btncheck-@day"
                                       checked="@DaySelection[day]"
                                       @onchange="(e => OnDayChanged(day, e.Value))"/>
                                <label class="btn btn-outline-light btn-sm w-100" for="btncheck-@day">
                                    @day.ToString().Substring(0, 3)
                                </label>
                            </div>
                        }
                    </div>
                </div>

                <div class="daily-schedule-table-wrapper d-none d-md-block">
                    <div class="daily-schedule-table-scroll">
                        <table class="table daily-schedule-table table-dark table-striped mb-0 align-middle">
                            <thead>
                            <tr>
                                <th>Day</th>
                                <th>Start</th>
                                <th>Stop</th>
                                <th>Play</th>
                                <th class="text-center">Synced</th>
                            </tr>
                            </thead>
                            <tbody>
                            @foreach (var day in Enum.GetValues<DayOfWeek>().OrderBy(d => ((int) d + 6) % 7))
                            {
                                if (!_settings.DailySchedules.ContainsKey(day))
                                    _settings.DailySchedules[day] = new DaySchedule();

                                var schedule = _settings.DailySchedules[day];
                                <tr>
                                    <td>@day.ToString().Substring(0, 3)</td>
                                    <td>
                                        <input type="time" class="form-control" value="@schedule.StartTime.ToString("HH:mm")"
                                               aria-label="@($"{day} Start Time")"
                                               @onchange="async e => { if (TimeOnly.TryParse(e.Value?.ToString(), out var t)) { schedule.StartTime = t; await SaveSettings(); } }"/>
                                    </td>
                                    <td>
                                        <input type="time" class="form-control" value="@schedule.StopTime.ToString("HH:mm")"
                                               aria-label="@($"{day} Stop Time")"
                                               @onchange="async e => { if (TimeOnly.TryParse(e.Value?.ToString(), out var t)) { schedule.StopTime = t; await SaveSettings(); } }"/>
                                    </td>
                                    <td>
                                        <select class="form-select"
                                                value="@GetScheduleSelection(schedule)"
                                                aria-label="@($"{day} Play Selection")"
                                                @onchange="async e => await SetScheduleSelection(schedule, e.Value?.ToString())">
                                            <option value="">-- None --</option>
                                            <option value="randomStation">Random Station</option>
                                            <option value="randomSpotify">Random Spotify</option>
                                            <option value="randomYouTube">Random YouTube Music</option>
                                            <optgroup label="Stations">
                                                @foreach (var station in _settings.Stations)
                                                {
                                                    <option value="station:@station.Url">@station.Name</option>
                                                }
                                            </optgroup>
                                            <optgroup label="Spotify">
                                                @foreach (var track in _settings.SpotifyTracks)
                                                {
                                                    <option value="spotify:@track.Url">@track.Name</option>
                                                }
                                            </optgroup>
                                            <optgroup label="YouTube Music">
                                                @foreach (var collection in _settings.YouTubeMusicCollections)
                                                {
                                                    <option value="youtube:@collection.Url">@collection.Name</option>
                                                }
                                            </optgroup>
                                        </select>
                                    </td>
                                    <td class="text-center">
                                        <InputCheckbox @bind-Value="schedule.IsSyncedPlayback" @bind-Value:after="SaveSettings" aria-label="@($"{day} Synced Playback")" />
                                    </td>
                                </tr>
                            }
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="schedule-card-list d-md-none">
                    @foreach (var day in Enum.GetValues<DayOfWeek>().OrderBy(d => ((int) d + 6) % 7))
                    {
                        if (!_settings.DailySchedules.ContainsKey(day))
                            _settings.DailySchedules[day] = new DaySchedule();

                        var schedule = _settings.DailySchedules[day];
                        <article class="schedule-card">
                            <header class="schedule-card__header">
                                <h6 class="mb-0">@day</h6>
                            </header>

                            <div class="schedule-card__body">
                                <div class="row g-2">
                                    <div class="col-6">
                                        <label class="form-label small mb-1">Start</label>
                                        <input type="time"
                                               class="form-control"
                                               value="@schedule.StartTime.ToString("HH:mm")"
                                               aria-label="@($"{day} Start Time")"
                                               @onchange="async e => { if (TimeOnly.TryParse(e.Value?.ToString(), out var t)) { schedule.StartTime = t; await SaveSettings(); } }" />
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small mb-1">Stop</label>
                                        <input type="time"
                                               class="form-control"
                                               value="@schedule.StopTime.ToString("HH:mm")"
                                               aria-label="@($"{day} Stop Time")"
                                               @onchange="async e => { if (TimeOnly.TryParse(e.Value?.ToString(), out var t)) { schedule.StopTime = t; await SaveSettings(); } }" />
                                    </div>
                                </div>

                                <div class="mt-2">
                                    <label class="form-label small mb-1">Play</label>
                                    <select class="form-select"
                                            value="@GetScheduleSelection(schedule)"
                                            aria-label="@($"{day} Play Selection")"
                                            @onchange="async e => await SetScheduleSelection(schedule, e.Value?.ToString())">
                                        <option value="">-- None --</option>
                                        <option value="randomStation">Random Station</option>
                                        <option value="randomSpotify">Random Spotify</option>
                                        <option value="randomYouTube">Random YouTube Music</option>
                                        <optgroup label="Stations">
                                            @foreach (var station in _settings.Stations)
                                            {
                                                <option value="station:@station.Url">@station.Name</option>
                                            }
                                        </optgroup>
                                        <optgroup label="Spotify">
                                            @foreach (var track in _settings.SpotifyTracks)
                                            {
                                                <option value="spotify:@track.Url">@track.Name</option>
                                            }
                                        </optgroup>
                                        <optgroup label="YouTube Music">
                                            @foreach (var collection in _settings.YouTubeMusicCollections)
                                            {
                                                <option value="youtube:@collection.Url">@collection.Name</option>
                                            }
                                        </optgroup>
                                    </select>
                                </div>

                                <div class="form-check form-switch mt-3">
                                    <input class="form-check-input"
                                           type="checkbox"
                                           checked="@schedule.IsSyncedPlayback"
                                           @onchange="async e => { schedule.IsSyncedPlayback = e.Value is bool b && b; await SaveSettings(); }"
                                           aria-label="@($"{day} Synced Playback")" />
                                    <label class="form-check-label">Synced playback</label>
                                </div>
                            </div>
                        </article>
                    }
                </div>
            }
            @if (_activeTab == "holidays")
            {
                <p class="form-text text-muted">
                    Import calendar dates or define one-off playback rules for specific days. Overrides replace the standard daily plan when an exact date matches.
                </p>

                <div class="holiday-import-panel">
                    <div class="holiday-import-actions">
                        <InputFile OnChange="ImportHolidayCalendarAsync" accept=".ics,text/calendar" disabled="@_importingCalendar"/>
                        <button type="button" class="btn btn-outline-info btn-sm" @onclick="ClearHolidayImportMessage" disabled="@(_importingCalendar || string.IsNullOrEmpty(_holidayImportMessage))">Clear Message</button>
                    </div>
                    <small class="text-muted">.ics files containing DTSTART entries are supported. New dates inherit the default start and stop times until edited.</small>
                    @if (!string.IsNullOrEmpty(_holidayImportMessage))
                    {
                        <div class="holiday-import-message">@_holidayImportMessage</div>
                    }
                </div>

                @if (!string.IsNullOrEmpty(_holidayValidationMessage))
                {
                    <div class="alert alert-danger">@_holidayValidationMessage</div>
                }

                <div class="holiday-table-wrapper d-none d-md-block">
                    <div class="holiday-table-scroll">
                        <table class="table holiday-schedule-table table-striped table-sm align-middle">
                            <thead>
                            <tr>
                                <th>Date</th>
                                <th>Name</th>
                                <th>Start</th>
                                <th>Stop</th>
                                <th>Play</th>
                                <th class="text-center">Synced</th>
                                <th class="text-end">Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            @foreach (var holiday in OrderedHolidaySchedules)
                            {
                                <tr>
                                    <td>
                                        <button class="form-control text-start" @onclick="() => OpenCalendar(holiday)" aria-label="@($"Change date for {holiday.Name}")">
                                            @holiday.Date.ToString("yyyy-MM-dd")
                                        </button>
                                    </td>
                                    <td>
                                        <input type="text" class="form-control" value="@holiday.Name"
                                               aria-label="@($"Holiday Name for {holiday.Date}")"
                                               @onchange="async e => { holiday.Name = e.Value?.ToString(); await SaveSettings(); }" title="@holiday.Name"/>
                                    </td>
                                    <td>
                                        <input type="time" class="form-control" value="@holiday.StartTime.ToString("HH:mm")"
                                               aria-label="@($"Start Time for {holiday.Name}")"
                                               @onchange="async e => { if (TimeOnly.TryParse(e.Value?.ToString(), out var t)) { holiday.StartTime = t; await SaveSettings(); } }"/>
                                    </td>
                                    <td>
                                        <input type="time" class="form-control" value="@holiday.StopTime.ToString("HH:mm")"
                                               aria-label="@($"Stop Time for {holiday.Name}")"
                                               @onchange="async e => { if (TimeOnly.TryParse(e.Value?.ToString(), out var t)) { holiday.StopTime = t; await SaveSettings(); } }"/>
                                    </td>
                                    <td>
                                        <select class="form-select" value="@GetScheduleSelection(holiday)" aria-label="@($"Play Selection for {holiday.Name}")" @onchange="async e => await SetScheduleSelection(holiday, e.Value?.ToString())">
                                            <option value="skip">-- Do not play --</option>
                                            <option value="randomStation">Random Station</option>
                                            <option value="randomSpotify">Random Spotify</option>
                                            <option value="randomYouTube">Random YouTube Music</option>
                                            <optgroup label="Stations">
                                                @foreach (var station in _settings.Stations)
                                                {
                                                    <option value="station:@station.Url">@station.Name</option>
                                                }
                                            </optgroup>
                                            <optgroup label="Spotify">
                                                @foreach (var track in _settings.SpotifyTracks)
                                                {
                                                    <option value="spotify:@track.Url">@track.Name</option>
                                                }
                                            </optgroup>
                                            <optgroup label="YouTube Music">
                                                @foreach (var collection in _settings.YouTubeMusicCollections)
                                                {
                                                    <option value="youtube:@collection.Url">@collection.Name</option>
                                                }
                                            </optgroup>
                                        </select>
                                    </td>
                                    <td class="text-center">
                                        <InputCheckbox @bind-Value="holiday.IsSyncedPlayback" @bind-Value:after="SaveSettings" aria-label="@($"Synced Playback for {holiday.Name}")" />
                                    </td>
                                    <td class="text-end">
                                        <button type="button" class="btn btn-outline-danger btn-sm" @onclick="async () => await RemoveHoliday(holiday)" aria-label="@($"Remove {holiday.Name}")">Remove</button>
                                    </td>
                                </tr>
                            }
                            @if (!OrderedHolidaySchedules.Any())
                            {
                                <tr>
                                    <td colspan="7" class="text-center text-muted">No holiday overrides configured.</td>
                                </tr>
                            }
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="holiday-card-list d-md-none">
                    @if (!OrderedHolidaySchedules.Any())
                    {
                        <div class="alert alert-secondary mb-0">No holiday overrides configured.</div>
                    }
                    else
                    {
                        @foreach (var holiday in OrderedHolidaySchedules)
                        {
                            <article class="holiday-card">
                                <header class="holiday-card__header">
                                    <button class="form-control text-start" @onclick="() => OpenCalendar(holiday)" aria-label="@($"Change date for {holiday.Name}")">
                                        @holiday.Date.ToString("yyyy-MM-dd")
                                    </button>
                                </header>

                                <div class="holiday-card__body">
                                    <div class="mb-2">
                                        <label class="form-label small mb-1">Name</label>
                                        <input type="text"
                                               class="form-control"
                                               value="@holiday.Name"
                                               aria-label="@($"Holiday Name for {holiday.Date}")"
                                               @onchange="async e => { holiday.Name = e.Value?.ToString(); await SaveSettings(); }" />
                                    </div>

                                    <div class="row g-2">
                                        <div class="col-6">
                                            <label class="form-label small mb-1">Start</label>
                                            <input type="time"
                                                   class="form-control"
                                                   value="@holiday.StartTime.ToString("HH:mm")"
                                                   aria-label="@($"Start Time for {holiday.Name}")"
                                                   @onchange="async e => { if (TimeOnly.TryParse(e.Value?.ToString(), out var t)) { holiday.StartTime = t; await SaveSettings(); } }" />
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label small mb-1">Stop</label>
                                            <input type="time"
                                                   class="form-control"
                                                   value="@holiday.StopTime.ToString("HH:mm")"
                                                   aria-label="@($"Stop Time for {holiday.Name}")"
                                                   @onchange="async e => { if (TimeOnly.TryParse(e.Value?.ToString(), out var t)) { holiday.StopTime = t; await SaveSettings(); } }" />
                                        </div>
                                    </div>

                                    <div class="mt-2">
                                        <label class="form-label small mb-1">Play</label>
                                        <select class="form-select"
                                                value="@GetScheduleSelection(holiday)"
                                                aria-label="@($"Play Selection for {holiday.Name}")"
                                                @onchange="async e => await SetScheduleSelection(holiday, e.Value?.ToString())">
                                            <option value="skip">-- Do not play --</option>
                                            <option value="randomStation">Random Station</option>
                                            <option value="randomSpotify">Random Spotify</option>
                                            <option value="randomYouTube">Random YouTube Music</option>
                                            <optgroup label="Stations">
                                                @foreach (var station in _settings.Stations)
                                                {
                                                    <option value="station:@station.Url">@station.Name</option>
                                                }
                                            </optgroup>
                                            <optgroup label="Spotify">
                                                @foreach (var track in _settings.SpotifyTracks)
                                                {
                                                    <option value="spotify:@track.Url">@track.Name</option>
                                                }
                                            </optgroup>
                                            <optgroup label="YouTube Music">
                                                @foreach (var collection in _settings.YouTubeMusicCollections)
                                                {
                                                    <option value="youtube:@collection.Url">@collection.Name</option>
                                                }
                                            </optgroup>
                                        </select>
                                    </div>

                                    <div class="d-flex align-items-center justify-content-between mt-3">
                                        <div class="form-check form-switch m-0">
                                            <input class="form-check-input"
                                                   type="checkbox"
                                                   checked="@holiday.IsSyncedPlayback"
                                                   @onchange="async e => { holiday.IsSyncedPlayback = e.Value is bool b && b; await SaveSettings(); }"
                                                   aria-label="@($"Synced Playback for {holiday.Name}")" />
                                            <label class="form-check-label">Synced playback</label>
                                        </div>
                                        <button type="button" class="btn btn-outline-danger btn-sm" @onclick="async () => await RemoveHoliday(holiday)" aria-label="@($"Remove {holiday.Name}")">Remove</button>
                                    </div>
                                </div>
                            </article>
                        }
                    }
                </div>

                <div class="mt-3 text-end">
                    <button type="button" class="btn btn-outline-primary" @onclick="AddHolidayOverride">Add Holiday</button>
                </div>
            }
        </div>
    </div>
    
    @if (_showCalendar && _editingHoliday is not null)
    {
        <Calendar InitialDate="_editingHoliday.Date.ToDateTime(TimeOnly.MinValue)" OnDateSelected="OnCalendarDateSelected" OnClose="CloseCalendar" />
    }
}

@code {

    private string _activeTab = "device";

    private bool _editingDiscordWebhook = false;
    private bool _editingTeamsWebhook = false;

    private string GetTruncatedUrl(string? url)
    {
        if (string.IsNullOrEmpty(url))
            return "Not Configured";

        if (url.Length <= 30)
            return url;

        return url.Substring(0, 30) + "...";
    }

    private SonosSettings? _settings;

    private TimeOnly TimeRightNow = TimeOnly.FromDateTime(DateTime.Now);

    private Dictionary<DayOfWeek, bool> DaySelection = new();

    private bool canEditIp;

    private bool _isRebooting;

    private string? _rebootAlertMessage;

    private string _rebootAlertCss = "alert-info";

    private string? _holidayValidationMessage;

    private string? _holidayImportMessage;

    private bool _importingCalendar;

    private bool _showCalendar = false;
    private HolidaySchedule? _editingHoliday;

    private void OpenCalendar(HolidaySchedule holiday)
    {
        _editingHoliday = holiday;
        _showCalendar = true;
    }

    private void CloseCalendar()
    {
        _showCalendar = false;
        _editingHoliday = null;
    }

    private async Task OnCalendarDateSelected(DateTime newDate)
    {
        if (_editingHoliday is not null)
        {
            _editingHoliday.Date = DateOnly.FromDateTime(newDate);
            await SaveSettings();
        }
        CloseCalendar();
    }

    private IEnumerable<HolidaySchedule> OrderedHolidaySchedules => _settings?.HolidaySchedules?.OrderBy(h => h.Date) ?? Enumerable.Empty<HolidaySchedule>();





    protected override async Task OnInitializedAsync()

    {

        await base.OnInitializedAsync();



        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();

        var user = authState.User;

        canEditIp = user.IsInRole("admin") || user.IsInRole("superadmin");



        if (user.Identity?.IsAuthenticated ?? false)

        {

            _settings = await _uow.SettingsRepo.GetSettings();
            if (_settings == null)
                _settings = new SonosSettings();

            _settings.YouTubeMusicCollections ??= new();

            _settings.HolidaySchedules ??= new();



            NormalizeSchedules();



            // Default to weekdays if no ActiveDays are set

            if (_settings.ActiveDays == null || !_settings.ActiveDays.Any())

            {

                _settings.ActiveDays = Enum.GetValues<DayOfWeek>()

                    .Where(d => d != DayOfWeek.Saturday && d != DayOfWeek.Sunday)

                    .ToList();



                // Persist the updated default back to the config file

                await _uow.SettingsRepo.WriteSettings(_settings);

            }



            // Build checkbox model

            foreach (DayOfWeek day in Enum.GetValues(typeof(DayOfWeek)))

            {

                DaySelection[day] = _settings.ActiveDays.Contains(day);

            }

        }

    }





    private TimeOnly StartTime

    {

        get => _settings!.StartTime;

        set

        {

            _settings!.StartTime = value;

            _ = SaveSettings();

            _ = AddLog("Starttime Changed", $"Time: {value}");

        }

    }



    private TimeOnly StopTime

    {

        get => _settings!.StopTime;

        set

        {

            _settings!.StopTime = value;

            _ = SaveSettings();

            _ = AddLog("Stoptime Changed", $"Time: {value}");

        }

    }



      private string AutoPlaySelection

      {

          get

          {

              if (_settings!.AutoPlayRandomStation)

                  return "randomStation";

              if (_settings.AutoPlayRandomSpotify)

                  return "randomSpotify";

              if (_settings.AutoPlayRandomYouTubeMusic)

                  return "randomYouTube";

              if (!string.IsNullOrEmpty(_settings.AutoPlayStationUrl))

                  return $"station:{_settings.AutoPlayStationUrl}";

              if (!string.IsNullOrEmpty(_settings.AutoPlaySpotifyUrl))

                  return $"spotify:{_settings.AutoPlaySpotifyUrl}";

              if (!string.IsNullOrEmpty(_settings.AutoPlayYouTubeMusicUrl))

                  return $"youtube:{_settings.AutoPlayYouTubeMusicUrl}";

              return string.Empty;

          }

          set

          {

              _settings!.AutoPlayRandomStation = false;

              _settings.AutoPlayRandomSpotify = false;

              _settings.AutoPlayRandomYouTubeMusic = false;

              _settings.AutoPlayStationUrl = null;

              _settings.AutoPlaySpotifyUrl = null;

              _settings.AutoPlayYouTubeMusicUrl = null;

              if (!string.IsNullOrEmpty(value))

              {

                  if (value == "randomStation")

                      _settings.AutoPlayRandomStation = true;

                  else if (value == "randomSpotify")

                      _settings.AutoPlayRandomSpotify = true;

                  else if (value == "randomYouTube")

                      _settings.AutoPlayRandomYouTubeMusic = true;

                  else

                  {

                      var parts = value.Split(':', 2);

                      if (parts[0] == "station")

                          _settings.AutoPlayStationUrl = parts[1];

                      else if (parts[0] == "spotify")

                          _settings.AutoPlaySpotifyUrl = parts[1];

                      else if (parts[0] == "youtube")

                          _settings.AutoPlayYouTubeMusicUrl = parts[1];

                  }

              }

              _ = SaveSettings();

          }

      }



    private int MaxVolume

    {

        get => Math.Clamp(_settings?.MaxVolume ?? 100, 0, 100);

        set

        {

            if (_settings is null)

                return;



            var clamped = Math.Clamp(value, 0, 100);



            if (_settings.MaxVolume == clamped)

                return;



            _settings.MaxVolume = clamped;



            if (_settings.Volume > clamped)

            {

                _settings.Volume = clamped;

            }



            _ = SaveSettings();

            _ = AddLog("Max Volume Changed", $"Value: {clamped}");

        }

    }



    private string GradientStartColor

    {

        get => NormalizeColor(_settings?.NowPlayingGradientStartColor, SonosSettings.DefaultNowPlayingGradientStartColor);

        set

        {

            if (_settings is null)

                return;



            var normalized = NormalizeColor(value, SonosSettings.DefaultNowPlayingGradientStartColor);



            if (_settings.NowPlayingGradientStartColor == normalized)

                return;



            _settings.NowPlayingGradientStartColor = normalized;

            _ = SaveSettings();

        }

    }



    private string GradientMidColor

    {

        get => NormalizeColor(_settings?.NowPlayingGradientMidColor, SonosSettings.DefaultNowPlayingGradientMidColor);

        set

        {

            if (_settings is null)

                return;



            var normalized = NormalizeColor(value, SonosSettings.DefaultNowPlayingGradientMidColor);



            if (_settings.NowPlayingGradientMidColor == normalized)

                return;



            _settings.NowPlayingGradientMidColor = normalized;

            _ = SaveSettings();

        }

    }



    private string GradientEndColor

    {

        get => NormalizeColor(_settings?.NowPlayingGradientEndColor, SonosSettings.DefaultNowPlayingGradientEndColor);

        set

        {

            if (_settings is null)

                return;



            var normalized = NormalizeColor(value, SonosSettings.DefaultNowPlayingGradientEndColor);



            if (_settings.NowPlayingGradientEndColor == normalized)

                return;



            _settings.NowPlayingGradientEndColor = normalized;

            _ = SaveSettings();

        }

    }



    private string GradientPreviewStyle => $"background: linear-gradient(135deg, {GradientStartColor} 0%, {GradientMidColor} 55%, {GradientEndColor} 100%);";



    private async Task SaveSettings()

    {

        if (_settings is null) return;

        

        _settings.ActiveDays = DaySelection

            .Where(kv => kv.Value)

            .Select(kv => kv.Key)

            .ToList();



        _settings.MaxVolume = Math.Clamp(_settings.MaxVolume, 0, 100);

        _settings.Volume = Math.Clamp(_settings.Volume, 0, _settings.MaxVolume);

        _settings.NowPlayingGradientStartColor = NormalizeColor(_settings.NowPlayingGradientStartColor, SonosSettings.DefaultNowPlayingGradientStartColor);

        _settings.NowPlayingGradientMidColor = NormalizeColor(_settings.NowPlayingGradientMidColor, SonosSettings.DefaultNowPlayingGradientMidColor);

        _settings.NowPlayingGradientEndColor = NormalizeColor(_settings.NowPlayingGradientEndColor, SonosSettings.DefaultNowPlayingGradientEndColor);

        _settings.HolidaySchedules ??= new();

        _settings.HolidaySchedules.Sort((a, b) => a.Date.CompareTo(b.Date));



        NormalizeSchedules();



        await _uow.SettingsRepo.WriteSettings(_settings);

    }



    private string GetScheduleSelection(DaySchedule schedule)

    {

        if (schedule is HolidaySchedule holiday)

        {

            if (holiday.SkipPlayback || !HasPlaybackTarget(holiday))

                return "skip";

        }



        if (schedule.PlayRandomStation)

            return "randomStation";

        if (schedule.PlayRandomSpotify)

            return "randomSpotify";

        if (schedule.PlayRandomYouTubeMusic)

            return "randomYouTube";

        if (!string.IsNullOrEmpty(schedule.StationUrl))

            return $"station:{schedule.StationUrl}";

        if (!string.IsNullOrEmpty(schedule.SpotifyUrl))

            return $"spotify:{schedule.SpotifyUrl}";

        if (!string.IsNullOrEmpty(schedule.YouTubeMusicUrl))

            return $"youtube:{schedule.YouTubeMusicUrl}";

        return string.Empty;

    }



    private void ApplyScheduleSelection(DaySchedule schedule, string? value)

    {

        schedule.PlayRandomStation = false;

        schedule.PlayRandomSpotify = false;

        schedule.PlayRandomYouTubeMusic = false;

        schedule.StationUrl = null;

        schedule.SpotifyUrl = null;

        schedule.YouTubeMusicUrl = null;



        var selection = value?.Trim();



        if (schedule is HolidaySchedule holiday)

        {

            holiday.SkipPlayback = false;



            if (string.IsNullOrEmpty(selection) || string.Equals(selection, "skip", StringComparison.OrdinalIgnoreCase))

            {

                holiday.SkipPlayback = true;

                return;

            }

        }

        else if (string.Equals(selection, "skip", StringComparison.OrdinalIgnoreCase))

        {

            selection = string.Empty;

        }



        if (string.IsNullOrEmpty(selection))

            return;



        if (selection == "randomStation")

            schedule.PlayRandomStation = true;

        else if (selection == "randomSpotify")

            schedule.PlayRandomSpotify = true;

        else if (selection == "randomYouTube")

            schedule.PlayRandomYouTubeMusic = true;

        else

        {

            var parts = selection.Split(':', 2);

            if (parts.Length == 2)

            {

                if (parts[0] == "station")

                    schedule.StationUrl = parts[1];

                else if (parts[0] == "spotify")

                    schedule.SpotifyUrl = parts[1];

                else if (parts[0] == "youtube")

                    schedule.YouTubeMusicUrl = parts[1];

            }

        }

    }



    private static bool HasPlaybackTarget(DaySchedule schedule)

    {

        return schedule.PlayRandomStation

               || schedule.PlayRandomSpotify

               || schedule.PlayRandomYouTubeMusic

               || !string.IsNullOrWhiteSpace(schedule.StationUrl)

               || !string.IsNullOrWhiteSpace(schedule.SpotifyUrl)

               || !string.IsNullOrWhiteSpace(schedule.YouTubeMusicUrl);

    }



    private async Task SetScheduleSelection(DaySchedule schedule, string? value)

    {

        ApplyScheduleSelection(schedule, value);

        await SaveSettings();

    }



    private void NormalizeSchedules()

    {

        if (_settings?.HolidaySchedules != null)

        {

            foreach (var holiday in _settings.HolidaySchedules)

            {

                if (!HasPlaybackTarget(holiday))

                    holiday.SkipPlayback = true;

            }

        }

    }



    private async Task AddHolidayOverride()

    {

        _holidayValidationMessage = null;

        if (_settings is null) return;



        var newDate = DateOnly.FromDateTime(DateTime.Now);

        while (_settings.HolidaySchedules.Any(h => h.Date == newDate))

        {

            newDate = newDate.AddDays(1);

        }



        var schedule = new HolidaySchedule

        {

            Date = newDate,

            StartTime = _settings.StartTime,

            StopTime = _settings.StopTime,

            Name = "New Holiday",

            SkipPlayback = true

        };

        

        _settings.HolidaySchedules.Add(schedule);

        await SaveSettings();

    }



    private async Task ImportHolidayCalendarAsync(InputFileChangeEventArgs args)

    {

        if (_settings is null)

            return;



        if (args.FileCount == 0)

        {

            _holidayImportMessage = "Choose a calendar file to import.";

            return;

        }



        _importingCalendar = true;

        _holidayImportMessage = null;



        try

        {

            var file = args.File;

            await using var stream = file.OpenReadStream(5 * 1024 * 1024);

            var events = await HolidayCalendarParser.ParseEventsAsync(stream);



            if (events.Count == 0)

            {

                _holidayImportMessage = "No events were found in the selected calendar.";

                return;

            }



            var added = 0;

            var updated = 0;



            foreach (var calendarEvent in events)

            {

                var existing = _settings.HolidaySchedules.FirstOrDefault(h => h.Date == calendarEvent.Date);

                if (existing == null)

                {

                    var schedule = new HolidaySchedule

                    {

                        Date = calendarEvent.Date,

                        Name = calendarEvent.Name,

                        StartTime = _settings.StartTime,

                        StopTime = _settings.StopTime

                    };

                    _settings.HolidaySchedules.Add(schedule);

                    added++;

                }

                else if (!string.IsNullOrWhiteSpace(calendarEvent.Name) && !string.Equals(existing.Name, calendarEvent.Name, StringComparison.Ordinal))

                {

                    existing.Name = calendarEvent.Name;

                    updated++;

                }

            }



            if (added > 0 || updated > 0)

            {

                await SaveSettings();

            }



            if (added > 0 || updated > 0)

                _holidayImportMessage = $"Imported {added} date(s) and updated {updated} existing entries.";

            else

                _holidayImportMessage = "Calendar import matched no new dates.";

        }

        catch (Exception ex)

        {

            _holidayImportMessage = $"Calendar import failed: {ex.Message}";

        }

        finally

        {

            _importingCalendar = false;

        }

    }



    private void ClearHolidayImportMessage()

    {

        _holidayImportMessage = null;

    }



    private async Task RemoveHoliday(HolidaySchedule holiday)

    {

        if (_settings?.HolidaySchedules == null)

            return;



        var confirmed = await JS.InvokeAsync<bool>("confirm", $"Are you sure you want to remove the holiday schedule for '{holiday.Name}'?");
        if (!confirmed) return;

        _settings.HolidaySchedules.Remove(holiday);
        await SaveSettings();
    }



    private async Task OnDayChanged(DayOfWeek dayKey, object? value)

    {

        bool isChecked = value is bool b && b;

        DaySelection[dayKey] = isChecked;



        await SaveSettings();

    }



    private static string NormalizeColor(string? value, string fallback)

    {

        if (string.IsNullOrWhiteSpace(value))

        {

            return fallback;

        }



        var trimmed = value.Trim();



        if (!trimmed.StartsWith("#", System.StringComparison.Ordinal))

        {

            trimmed = $"#{trimmed.TrimStart('#')}";

        }



        if (trimmed.Length == 7)

        {

            return trimmed;

        }



        if (trimmed.Length == 4)

        {

            return $"#{trimmed[1]}{trimmed[1]}{trimmed[2]}{trimmed[2]}{trimmed[3]}{trimmed[3]}";

        }



        if (trimmed.Length > 7)

        {

            return trimmed.Substring(0, 7);

        }



        return fallback;

    }





    private string _newSpeakerName = "";
    private string _newSpeakerIp = "";
    private string? _speakerValidationMessage;
    private bool _isAddingSpeaker;

    private bool ValidateIpAddress(string ip)
    {
        if (string.IsNullOrWhiteSpace(ip)) return false;

        if (!IPAddress.TryParse(ip, out var address)) return false;

        // IPv4 only for now as Sonos usually operates on IPv4
        if (address.AddressFamily != System.Net.Sockets.AddressFamily.InterNetwork) return false;

        // Block loopback (127.0.0.0/8)
        if (IPAddress.IsLoopback(address)) return false;

        // Block 0.0.0.0
        if (address.Equals(IPAddress.Any)) return false;

        return true;
    }

    private async Task AddSpeaker()
    {
        _speakerValidationMessage = null;
        if (_settings is null || string.IsNullOrWhiteSpace(_newSpeakerIp)) return;

        if (!ValidateIpAddress(_newSpeakerIp))
        {
            _speakerValidationMessage = "Invalid IP address. Please enter a valid non-loopback IPv4 address.";
            return;
        }

        _isAddingSpeaker = true;
        try
        {
            var name = string.IsNullOrWhiteSpace(_newSpeakerName) ? "New Speaker" : _newSpeakerName;

            _settings.Speakers.Add(new SonosSpeaker { Name = name, IpAddress = _newSpeakerIp });
            _newSpeakerName = "";
            _newSpeakerIp = "";

            await SaveSettings();
            await AddLog("Speaker Added", $"{name} ({_newSpeakerIp})");
        }
        finally
        {
            _isAddingSpeaker = false;
        }
    }

    private async Task RemoveSpeaker(SonosSpeaker speaker)
    {
        if (_settings is null) return;

        var confirmed = await JS.InvokeAsync<bool>("confirm", $"Are you sure you want to remove speaker '{speaker.Name}'?");
        if (!confirmed) return;

        _settings.Speakers.Remove(speaker);
        await SaveSettings();
        await AddLog("Speaker Removed", $"{speaker.Name} ({speaker.IpAddress})");
    }

    private async Task UpdateStartupVolume(SonosSpeaker speaker, object? value)
    {
        if (value is string s && int.TryParse(s, out int volume))
        {
            var clamped = Math.Clamp(volume, 0, 100);
            speaker.StartupVolume = clamped;
        }
        else
        {
            speaker.StartupVolume = null;
        }
        await SaveSettings();
    }



    private async Task AddLog(string action, string? details = null)

    {

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();

        var user = authState.User;

        var username = user.Identity?.Name ?? "Unknown";



        var log = new LogEntry

        {

            Action = action,

            PerformedBy = username,

            Timestamp = DateTime.UtcNow,

            Details = details

        };



        Db.Logs.Add(log);

        await Db.SaveChangesAsync();

    }

}




